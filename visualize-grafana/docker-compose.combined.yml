# Optimized Visualize + Grafana Stack
# Uses official Grafana image (fast) + optimized visualize build
# Run with: docker-compose -f docker-compose.combined.yml up --build

version: "3.8"

services:
  # PostgreSQL database
  db:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: visualization_tool
      POSTGRES_PASSWORD: password
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # Grafana (official image - instant startup)
  grafana:
    image: grafana/grafana:10.2.0
    ports:
      - "3003:3000"
    environment:
      - GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS=flandersmake-sparql-datasource
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Editor
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_ALLOW_EMBEDDING=true
      - GF_SECURITY_COOKIE_SAMESITE=none
      - GF_USERS_DEFAULT_THEME=light
      - GF_LOG_LEVEL=warn
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/plugins:/var/lib/grafana/plugins
      - grafana-data:/var/lib/grafana
    restart: unless-stopped

  # Visualize (optimized build)
  visualize:
    build:
      context: .
      dockerfile: Dockerfile.combined
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: postgres://postgres:password@db:5432/visualization_tool
      ENDPOINT: sparql+https://lindas.admin.ch/query
      SPARQL_GEO_ENDPOINT: https://geo.ld.admin.ch/query
      GRAPHQL_ENDPOINT: /api/graphql
      WHITELISTED_DATA_SOURCES: '["Prod", "Prod-uncached", "Int", "Int-uncached"]'
      NEXT_PUBLIC_GRAFANA_URL: http://localhost:3003
      NEXT_PUBLIC_GRAFANA_DATASOURCE_UID: lindas-datasource
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

volumes:
  postgres-data:
  grafana-data:
